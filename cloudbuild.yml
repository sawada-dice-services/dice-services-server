steps:

- name: "golang"
  args: ["go", "build", "-o", "main", "./main.go"]
  dir: "./"
  id: "go-build"

- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', '$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/server-image:$SHORT_SHA', '.' ]
  id: "docker-build"
  waitFor: ["go-build"]
images:
- '$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/server-image'

- name: "gcr.io/cloud-builders/gcloud"
  args:
    - "run"
    - "deploy"
    - "--image"
    - "$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/server-image"
    - "--max-instances"
    - "1"
    - "--allow-unauthenticated"
  waitFor: ["go-build"]